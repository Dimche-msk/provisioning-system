# Provisioning System

## 1. System Purpose

**Provisioning System** is a centralized system for automated management of IP phone configurations. It solves the problem of mass configuration and maintenance of a fleet of telephone sets from various manufacturers.

**The system is fully generated by Google's "Gemini 3" AI.**
This development served as a test for the model, which it handled perfectly.
The model was presented with an architecture that suited my current tasks, and then given instructions to implement specific functionality or fix errors.
Throughout the entire development process, I only had to "touch" the code a couple of times; the AI did the rest.

The system is designed to be deployed on a server and is managed via a web interface.

Key features of the system:
*   **Multi-vendor Support**: Support for any phone models (Cisco, Yealink, Fanvil, etc.) through a flexible template system (Jinja2-like syntax).
*   **Multi-domain Support**: Ability to maintain independent configurations for different branches or clients (domains).
*   **Web Interface**: A convenient UI for adding phones, managing lines, configuring buttons (BLF, Speed Dial), and importing data from Excel.
*   **Configuration Generation**: Automatic creation of configuration files when settings are changed.
*   **Phone Directories**: Automatic generation and updating of corporate phone books (XML Directory) for each domain.
*   **Automation**: Support for deploy scripts (Deploy Commands) for automatic delivery of configurations to TFTP/HTTP servers. Ability to execute commands that create or delete phones on the PBX when data changes in the system (PBX Automation).
*   **Password Generation**: Optional automatic generation of secure SIP passwords.
*   **Multilingual Support**: The system interface works in Russian and English. There is an option to add other languages.
*   **Login/Password Authorization**: The current release supports authorized administrator access.

## 2. Deployment Overview

The source code of the project is available in the repository: [https://github.com/Dimche-msk/provisioning-system.git](https://github.com/Dimche-msk/provisioning-system.git)

The system is delivered as a compiled executable file (single binary), which contains both the backend and the frontend.

### Installation from Releases

1.  **Download**:
    Go to the [Releases](https://github.com/Dimche-msk/provisioning-system/releases) section on GitHub and download the archive with the executable file for your OS:
    *   `provisioning-system-linux-amd64` (Linux 64-bit)
    *   `provisioning-system-linux-386` (Linux 32-bit)
    *   `provisioning-system-windows-amd64.exe` (Windows 64-bit)

2.  **Directory Structure**:
    Create a working folder for the application and place the following in it:
    *   The application executable file.
    *   A `conf/` folder containing:
        *   `provisioning-system.yaml` — the main configuration file.
        *   `vendors/` — directory with vendor templates.

    Example structure:
    ```text
    /opt/provisioning-system/
    ├── provisioning-system-linux-amd64
    └── conf/
        ├── provisioning-system.yaml
        └── vendors/
            ├── cisco/
            │   ├── models/
            │   ├── templates/
            │   ├── directory/
            │   └── vendor.yaml
            └── yealink/
                └── ...
    ```

3.  **Configuration**:
    Configure `conf/provisioning-system.yaml` by specifying database parameters, web server port, and domain settings.

4.  **Run**:
    *   **Linux**:
        ```bash
        chmod +x provisioning-system-linux-amd64
        ./provisioning-system-linux-amd64
        ```
        *It is recommended to run via systemd as a service.*

    *   **Windows**:
        Run `provisioning-system-windows-amd64.exe` via the command line or as a service.

### Command Line Arguments

The following flags can be used when running the executable:

*   `--config-dir` — Path to the directory containing `provisioning-system.yaml` and the `vendors/` folder (defaults to `.`).
*   `--log-level` — Server logging level (`DEBUG`, `INFO`, `WARN`, `ERROR`). Defaults to `ERROR`. For detailed debugging, use `INFO` or `DEBUG`.

5.  **Usage**:
    Open a browser and go to `http://<server-address>:8080` (default port). Login and password are set in the configuration file.

6. **Database location**:
    The database is located in the `backend/` folder and is named `provisioning.db`.
    Backups are stored in the `backend/backups/` folder.

### Building from Source

If you want to build the project yourself:

**Requirements**:
*   Go 1.21 or higher
*   Node.js 18 or higher (for building the frontend)

**Build Steps**:

1.  Clone the repository:
    ```bash
    git clone https://github.com/Dimche-msk/provisioning-system.git
    cd provisioning-system
    ```

2.  Build the frontend:
    ```bash
    cd frontend
    npm install
    npm run build
    cd ..
    ```
    *Compiled frontend files will be placed in `backend/cmd/server/static`.*

3.  Build the backend:
    ```bash
    cd backend
    go build -o provisioning-system cmd/server/main.go
    ```

4.  The ready binary file `provisioning-system` (or `.exe`) will appear in the `backend` folder.


### Running dev server
1. run backend
```bash
go -C backend run cmd/server/main.go --config-dir ../conf
```
2. run frontend
```bash
cd frontend
npm run dev
```

## 3. System Configuration

The main configuration file `conf/provisioning-system.yaml` controls server parameters, database, authorization, and domain settings.

### Main Sections

*   **server**: Web server settings.
    *   `listen_address`: IP address to listen on (default "0.0.0.0"). Multiple addresses can be specified using a comma (e.g., "127.0.0.1, 192.168.1.10").
    *   `port`: Port on which the web interface will be available (default "8090").
    *   `serve_configs`: If `true`, the system serves generated configuration files via HTTP.
    *   `log_device_access`: Device access logging level (`none`, `access`, `error`, `full`).
    *   `log_file_path`: Path to the access log file.

*   **auth**: Security settings.
    *   `admin_user`: Administrator login.
    *   `admin_password`: Administrator password.
    *   `secret_key`: Secret key for signing sessions (JWT).

*   **database**: Database settings.
    *   `path`: Path to the SQLite database file (e.g., `provisioning.db`).
    *   `backup_dir`: Folder for storing automatic database backups.

*   **licensing**: (Internal) License management.
    *   The system looks for `license.key` in the configuration directory.
    *   See [technical_design.md](technical_design.md) for data format and fields.

*   **domains**: List of domains (branches/clients). Each domain has its own unique settings and variables.
    *   `name`: Unique domain name (used in URLs and file paths).
    *   `deploy_commands`: List of commands executed after configuration generation (e.g., copying files to TFTP server, reloading PBX). Supports templating.
    *   `delete_commands`: List of commands executed when deleting a phone.
    *   `generate_random_password`: If `True`, the system automatically generates a password for new phones if one is not set.
    *   `variables`: Arbitrary variables (key-value) available in configuration templates (e.g., SIP server IP, NTP server, VLAN, etc.).

### Configuration Example

```yaml
server:
  port: "8090"
  serve_configs: true
  log_device_access: full
  log_file_path: ./access.log

auth:
  admin_user: "admin"
  admin_password: "password123"
  secret_key: "change-me-to-something-secure"

database:
  path: "provisioning.db"
  backup_dir: "backups"

domains:
  - name: "MainOffice"
    generate_random_password: True
    deploy_commands:
      - "scp {{.FilePath}} user@tftp-server:/tftpboot/"
      - "ssh user@asterisk 'asterisk -rx \"sip reload\"'"
    variables:
      ntp_server: "pool.ntp.org"
      sip_server_ip: "192.168.1.10"
      sip_server_port: "5060"
      timezone: "Europe/Moscow"

  - name: "BranchOffice"
    variables:
      ntp_server: "pool.ntp.org"
      sip_server_ip: "10.10.1.10"
      sip_server_port: "5060"
```

## 4. Vendor Configuration

The system allows for easy addition of support for new phone manufacturers. Configuration for each vendor is located in a separate folder within `conf/vendors/` (e.g., `conf/vendors/cisco/`).

### vendor.yaml File

The root of the vendor folder must contain a `vendor.yaml` file describing the main parameters.

Example (`conf/vendors/cisco/vendor.yaml`):

```yaml
id: cisco                     # Unique Vendor ID
name: Cisco                   # Display Name
static_dir: static            # Folder with static files (firmware, images) to be copied as is
phone_config_file: "spa{{account.mac_address}}.xml" # Configuration file name template
phone_config_template: templates/phone.tpl          # Path to the main configuration template
features_file: templates/features.yaml              # [Optional] Path to advanced features definition
accounts_file: accounts.yaml                        # [Optional] Path to account definitions (dynamic UI fields for SIP lines)
```

### SIP Account Configuration (accounts.yaml)

The `accounts_file` (usually `accounts.yaml`) allows you to define which fields will be displayed in the web interface when editing a phone line (SIP account). This makes the UI dynamic and adaptable to different vendors.

For example, if a vendor requires a **Proxy IP** and **Proxy Port**, you can define them in `accounts.yaml`, and they will automatically appear in the "Line" editing dialog.

Example `accounts.yaml`:
```yaml
- id: account
  name: SIP Account
  params:
    - id: user_name
      label: Username
      type: string
    - id: password
      label: Password
      type: password
    - id: proxy_ip
      label: Proxy IP
      type: string
```

### Advanced Feature Configuration (features.yaml)

The `features_file` allows you to define complex programmable keys (BLF, Speed Dial, etc.) with custom UI fields and configuration templates. Templates are processed using **Pongo2** (Jinja2-like syntax), allowing for conditions, filters, and dynamic tag mapping.

#### File Structure
The file contains a list of features. Each feature has:
*   **`id`**: Unique identifier for the feature type.
*   **`name`**: Human-readable name displayed in the UI dropdown.
*   **`params`**: List of parameters for this feature.

#### Parameter Fields
*   **`id`**: Parameter identifier.
*   **`label`**: Label displayed in the phone editing form.
*   **`type`**: UI field type (`string`, `boolean`, `number`, `select`, `hidden`).
*   **`value`**: (Optional) Fixed value for this parameter (useful with `hidden` type).
*   **`source`**: (Optional) For `select` type, specifies the data source (e.g., `lines`).
*   **`config_template`**: Template for the generated configuration line.

#### Placeholders in `config_template`
Templates are rendered using **Pongo2** and have access to the following context:

**Parameter Context:**
*   **`{{id}}`**: The ID of the current parameter (from `features.yaml`).
*   **`{{value}}`**: The value of the current parameter.
*   **`{{[custom_field]}}`**: Any arbitrary fields defined for the parameter in `features.yaml` (e.g., `{{param}}`).

**Key/Line Context (from Model and Database):**
*   **`{{key_index}}`**: Sequential index of the line/key (1-N).
*   **`{{key_number}}`**: Physical button index on the device or module.
*   **`{{expansion_module}}`**: Number of the expansion module (0 for main device).
*   **`{{key_type}}`**: Type of the key defined in the model (e.g., `line`, `soft_key`).
*   **`{{label}}`**: Label of the key defined in the model.
*   **`{{tag}}`**: Vendor-specific tag mapping for the current parameter ID from model `settings`.
*   **`{{settings}}`**: Full map of all settings defined for this key in the model.

#### Example (Mitel BLF with Custom Parameter)
In `features.yaml`:
```yaml
- id: blf
  params:
    - id: label
      param: const
      config_template: "{{tag}}/{{param}}:{{value}}"
```
If Model defines `tag` for `label` as `softkey3 label`, result: `softkey3 label/const: MyValue`

### Templates

Templates use **Pongo2** syntax (similar to Jinja2 for Go). They allow dynamic formation of configuration files based on phone and domain data.

#### Available Variables in Templates

The following objects are available in templates:

1.  **`account`** — Current phone object:
    *   `mac_address`: Phone MAC address (automatically cleaned of colons, e.g., `001565ABCDEF`). Standard filters `|upper` and `|lower` are available to change the case.
    *   `phone_number`: Main phone number.
    *   `lines`: List of phone lines.
        *   `number`: Line number (1, 2, ...).
        *   `auth_name`: Authorization name (from Additional Info).
        *   `password`: Password (from Additional Info).
        *   `display_name`: Display name.
        *   `registrar1_ip`, `registrar1_port`: SIP server address.
    *   `max_lines`: Maximum number of lines for this model.
    *   `lines_range`: Array of line numbers (for iteration).
    *   `used_line_numbers`: Map of used line numbers.

2.  **`domain`** — Current domain object:
    *   `name`: Domain name.
    *   Any variables defined in `provisioning-system.yaml` in the `variables` section (e.g., `domain.sip_server_ip`, `domain.ntp_server`).

3.  **`phones`** — List of all phones in the current domain (useful for generating directories).

4.  **`all_domains`** — List of all domains and their phones (for global directories).

#### Template Example (Cisco)

```xml
<flat-profile>
    <!-- VLAN settings from domain variables -->
    {%- if domain.vlan_voip %}
    <Enable_VLAN>Yes</Enable_VLAN>
    <VLAN_ID>{{ domain.vlan_voip }}</VLAN_ID>
    {%- endif %}

    <!-- Iterating through phone lines -->
    {%- for line in account.lines %}
    {%- if line.type == "line" %}
    <!-- Line {{line.number}} -->
    <User_ID_{{line.number}}_>{{ line.auth_name|default:line.phone_number }}</User_ID_{{line.number}}_>
    <Password_{{line.number}}_>{{ line.password|default:domain.sip_password }}</Password_{{line.number}}_>
    <Proxy_{{line.number}}_>{{ line.registrar1_ip|default:domain.sip_server_ip }}</Proxy_{{line.number}}_>
    {%- endif %}
    {%- endfor %}

    <!-- Global settings -->
    <Primary_NTP_Server>{{domain.ntp_server|default:"pool.ntp.org"}}</Primary_NTP_Server>
</flat-profile>
```

### Directory Generation

To automatically generate phone books, create a `directory` folder inside the vendor folder (e.g., `conf/vendors/cisco/directory/`). Place a template there (e.g., `directory.xml.tpl`).

This template will be automatically processed whenever phones are changed, and the result will be saved to the root of the domain configuration.

Directory template example:
```xml
{% for domain in all_domains %}
        <!-- Domain: {{ domain.name }} -->
        {% for phone in domain.phones %}
        <!-- Phone: {{ phone.MacAddress }} -->
<Description>{{ phone.Description }}</Description>
<Number>{{ phone.PhoneNumber }}</Number>
        {% for line in phone.Lines %}
        {% set info = line.GetAdditionalInfoMap() %}
<Entry>
<Name>{{ info.display_name }}</Name>
<UserName>{{ info.user_name }}</UserName>
<Registrar>{{ info.registrar1_ip }}</Registrar>
</Entry>
        {% endfor %}
        {% endfor %}
        {% endfor %}
```

## 5. Interface Description

The system's web interface provides full control over the provisioning process.

### Login
Upon first login, you must enter the administrator login and password specified in `provisioning-system.yaml`.

### Dashboard
The main page displays general statistics:
*   Total number of phones in the system.
*   Distribution of phones by domain and vendor.

### Phones
The main section for working with devices.
*   **Search and Filter**: Search by MAC address, number, description, or IP address. Filter by domain and vendor.
*   **Add Phone**: The "Add Phone" button opens the form for creating a new device.
*   **Edit**: Clicking on a table row opens detailed phone settings.
*   **Import**: The "Import" button allows bulk uploading of phones from an Excel file.

#### Excel Import Format

The system supports bulk importing of phones from Excel files (`.xlsx` or `.xls`). The importer automatically detects columns based on keywords in the header row (first row).

| Column | English Keywords | Russian Keywords | Required | Description |
| :--- | :--- | :--- | :---: | :--- |
| **MAC Address** | `mac` | `мак` | Yes | Unique device MAC address (e.g., `001122334455`) |
| **Phone Number** | `number` | `номер` | Yes | Main phone number / Line 1 number |
| **Description** | `description`, `описание` | No | Display description for the phone |
| **Vendor** | `vendor` | `производитель` | Yes | Vendor Name (e.g., `Mitel`) or Vendor ID (`mitel`) |
| **Model** | `model` | `модель` | Yes | Model Name (e.g., `6873i`) or Model ID |
| **Domain** | `domain` | `домен` | No | Domain name (defaults to first available if empty) |
| **SIP Login** | `login` | `логин` | No | SIP authorization name (defaults to phone number) |
| **SIP Password**| `password` | `пароль` | No | SIP password (defaults to domain's `sip_password` variable) |

**Notes:**
- Vendors and Models must already exist in the system configuration.
- The importer creates **one SIP line** (Line 1) for each phone.
- If a phone with the same MAC address already exists, you can choose to skip or overwrite.

#### Dynamic Column Mapping
Any column in the Excel file that is not recognized as a standard field (MAC, Number, Vendor, Model, Domain, Description) will be automatically imported into the phone's **Line 1** custom parameters (`additional_info`). This allows you to bulk-import vendor-specific settings like `proxy_ip`, `vlan_id`, or `display_name` directly from your spreadsheet.

### Editing a Phone
In the phone card, you can configure:
*   **Basic Parameters**: MAC, model, domain, description.
*   **Lines**: Configuration of SIP accounts for each line (number, password, display name).
*   **Keys**: Configuration of programmable buttons (BLF, Speed Dial), if supported by the model.

### System
Section for administrative actions.
*   **Prepare Configuration (Reload)**: Re-reads all configuration files (yaml, templates) and generates configuration files for all phones. Used after changing templates or global settings.
*   **Apply Configuration (Deploy)**: Applies generated configurations (copies them to the TFTP/HTTP server working folder).
*   **Backup/Restore**: Creating a backup of the database and restoring from it.
