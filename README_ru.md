# Provisioning System

## 1. Назначение системы

**Provisioning System** — это централизованная система для автоматизированного управления конфигурациями IP-телефонов. Она решает задачу массовой настройки и сопровождения парка телефонных аппаратов различных производителей.

**Система полностью сгенерирована ИИ от Google "Gemini 3".** 
Эта разработка стала тестом модели, с которым модель прекрасно справилась. 
Модели была предложена архитектура, которая подходила под мои текущие задачи, далее модели давались указания реализовать тот или иной функционал или исправить ошибки.
За все время разработки, мне пришлось только пару раз "прикоснуться" к коду, все остальное сделал ИИ

Система предназначена для развертывания на сервере и управляется через web-интерфейс.

## Варианты применения системы:
* **Простой вариант**: Система запускается на сервере АТС или отдельном сервере. Сама система служит сервером конфигураций (provisioning сервер), для скачивания конфигов телефоны используют http-сервер встроенный в систему. Скорее всего будет настроен только один домен (на предприятии одна локация и одна АТС)
* **Большая телефонная сеть**: Система запущена в любом месте сети (хоть на компьютере админа). В системе настроены домены и комманды деплоя (выгрузки) конфигураций. Сама система не обслуживает запросы от телефонов, а только раскладывает сгенерированные конфиги по серверам на разных локациях.

## Основные возможности системы:
*   **Мультивендорность**: Поддержка любых моделей телефонов (Cisco, Yealink, Fanvil и др.) через гибкую систему шаблонов (Jinja2-like синтаксис).
*   **Мультидоменность**: Возможность ведения независимых конфигураций для разных филиалов или клиентов (доменов).
*   **Веб-интерфейс**: Удобный UI для добавления телефонов, управления линиями, настройки кнопок (BLF, Speed Dial) и импорта данных из Excel.
*   **Генерация конфигураций**: Автоматическое создание конфигурационных файлов при изменении настроек.
*   **Телефонные справочники**: Автоматическая генерация и обновление корпоративных телефонных книг (XML Directory) для каждого домена.
*   **Автоматизация**: Поддержка скриптов деплоя (Deploy Commands) для автоматической доставки конфигураций на TFTP/HTTP сервера. Возможность выполнения команд, создающих или удаляющих телефоны на АТС при изменении данных в системе (Автоматизация АТС)
*   **Генерация паролей**: Опциональная автоматическая генерация безопасных SIP-паролей.
*   **Поддержка многоязычности**: Интерфейс системы работает на русском и английском языке. Есть возможность добавления других языков.  
*   **Авторизация по логин/пароль**: Текущий релиз поддерживает авторизованный доступ администратора  



## 2. Общее описание развертывания системы

Исходный код проекта доступен в репозитории: [https://github.com/Dimche-msk/provisioning-system.git](https://github.com/Dimche-msk/provisioning-system.git)

Система поставляется в виде скомпилированного исполняемого файла (single binary), который содержит в себе и бэкенд, и фронтенд.

### Установка из готовых релизов

1.  **Скачивание**:
    Перейдите в раздел [Releases](https://github.com/Dimche-msk/provisioning-system/releases) на GitHub и скачайте архив с исполняемым файлом для вашей ОС:
    *   `provisioning-system-linux-amd64` (Linux 64-bit)
    *   `provisioning-system-linux-386` (Linux 32-bit)
    *   `provisioning-system-windows-amd64.exe` (Windows 64-bit)

2.  **Структура директорий**:
    Создайте рабочую папку для приложения и разместите в ней:
    *   Исполняемый файл приложения.
    *   Папку `conf/`, содержащую:
        *   `provisioning-system.yaml` — основной файл конфигурации.
        *   `vendors/` — директория с шаблонами производителей.

    Пример структуры:
    ```text
    /opt/provisioning-system/
    ├── provisioning-system-linux-amd64
    └── conf/
        ├── provisioning-system.yaml
        └── vendors/
            ├── cisco/
            │   ├── models/
            │   ├── templates/
            │   ├── directory/
            │   └── vendor.yaml
            └── yealink/
                └── ...
    ```

3.  **Конфигурация**:
    Настройте `conf/provisioning-system.yaml`, указав параметры базы данных, порта веб-сервера и настройки доменов.

4.  **Запуск**:
    *   **Linux**:
        ```bash
        chmod +x provisioning-system-linux-amd64
        ./provisioning-system-linux-amd64
        ```
        *Рекомендуется запускать через systemd как сервис.*

    *   **Windows**:
        Запустите `provisioning-system-windows-amd64.exe` через командную строку или как службу.

### Параметры запуска (CLI Arguments)

При запуске исполняемого файла можно использовать следующие флаги:

*   `--config-dir` — Путь к папке, содержащей `provisioning-system.yaml` и директорию `vendors/` (по умолчанию `.`).
*   `--log-level` — Уровень логирования сервера (`DEBUG`, `INFO`, `WARN`, `ERROR`). По умолчанию `ERROR`. Для детальной отладки рекомендуется использовать `INFO` или `DEBUG`.

5.  **Использование**:
    Откройте браузер и перейдите по адресу `http://<адрес-сервера>:8080` (порт по умолчанию). Логин и пароль задаются в конфигурационном файле.

### Сборка из исходного кода

Если вы хотите собрать проект самостоятельно:

**Требования**:
*   Go 1.21 или выше
*   Node.js 18 или выше (для сборки фронтенда)

**Шаги сборки**:

1.  Клонируйте репозиторий:
    ```bash
    git clone https://github.com/Dimche-msk/provisioning-system.git
    cd provisioning-system
    ```

2.  Соберите фронтенд:
    ```bash
    cd frontend
    npm install
    npm run build
    cd ..
    ```
    *Скомпилированные файлы фронтенда будут помещены в `backend/cmd/server/static`.*

3.  Соберите бэкенд:
    ```bash
    cd backend
    go build -o provisioning-system cmd/server/main.go
    ```

4.  Готовый бинарный файл `provisioning-system` (или `.exe`) появится в папке `backend`.

## 3. Конфигурация системы

Основной файл конфигурации `conf/provisioning-system.yaml` управляет параметрами сервера, базы данных, авторизации и настройками доменов.

### Основные секции

*   **server**: Настройки веб-сервера.
    *   `listen_address`: IP-адрес для прослушивания (по умолчанию "0.0.0.0"). Можно указать несколько адресов через запятую (например, "127.0.0.1, 192.168.1.10").
    *   `port`: Порт, на котором будет доступен веб-интерфейс (по умолчанию "8090").
    *   `serve_configs`: Если `true`, система сама отдает сгенерированные файлы конфигурации по HTTP.
    *   `log_device_access`: Уровень логирования доступа устройств (`none`, `access`, `error`, `full`).
    *   `log_file_path`: Путь к файлу логов доступа.

*   **auth**: Настройки безопасности.
    *   `admin_user`: Логин администратора.
    *   `admin_password`: Пароль администратора.
    *   `secret_key`: Секретный ключ для подписи сессий (JWT).

*   **database**: Настройки базы данных.
    *   `path`: Путь к файлу базы данных SQLite (например, `provisioning.db`).
    *   `backup_dir`: Папка для хранения автоматических бэкапов базы данных.

*   **licensing**: (Внутреннее) Управление лицензиями.
    *   Система ищет файл `license.key` в директории конфигурации.
    *   Подробное описание формата данных и полей доступно в [technical_design.md](technical_design.md).

*   **domains**: Список доменов (филиалов/клиентов). Каждый домен имеет свои уникальные настройки и переменные.
    *   `name`: Уникальное имя домена (используется в URL и путях к файлам).
    *   `deploy_commands`: Список команд, выполняемых после генерации конфигурации (например, копирование файлов на TFTP сервер, перезагрузка АТС). Поддерживает шаблонизацию.
    *   `delete_commands`: Список команд, выполняемых при удалении телефона.
    *   `generate_random_password`: Если `True`, система автоматически генерирует пароль для новых телефонов, если он не задан.
    *   `variables`: Произвольные переменные (ключ-значение), которые доступны в шаблонах конфигурации (например, IP адрес SIP сервера, NTP сервер, VLAN и т.д.).

### Пример конфигурации

```yaml
server:
  port: "8090"
  serve_configs: true
  log_device_access: full
  log_file_path: ./access.log

auth:
  admin_user: "admin"
  admin_password: "password123"
  secret_key: "change-me-to-something-secure"

database:
  path: "provisioning.db"
  backup_dir: "backups"

domains:
  - name: "MainOffice"
    generate_random_password: True
    deploy_commands:
      - "scp {{.FilePath}} user@tftp-server:/tftpboot/"
      - "ssh user@asterisk 'asterisk -rx \"sip reload\"'"
    variables:
      ntp_server: "pool.ntp.org"
      sip_server_ip: "192.168.1.10"
      sip_server_port: "5060"
      timezone: "Europe/Moscow"

  - name: "BranchOffice"
    variables:
      ntp_server: "pool.ntp.org"
      sip_server_ip: "10.10.1.10"
      sip_server_port: "5060"
```

## 4. Настройка вендоров (Vendor Configuration)

Система позволяет легко добавлять поддержку новых производителей телефонов. Конфигурация каждого вендора находится в отдельной папке внутри `conf/vendors/` (например, `conf/vendors/cisco/`).

### Файл vendor.yaml

В корне папки вендора должен находиться файл `vendor.yaml`, описывающий основные параметры.

Пример (`conf/vendors/cisco/vendor.yaml`):

```yaml
id: cisco                     # Уникальный ID вендора
name: Cisco                   # Отображаемое имя
static_dir: static            # Папка со статическими файлами (прошивки, картинки), которые будут скопированы как есть
phone_config_file: "spa{{account.mac_address}}.xml" # Шаблон имени файла конфигурации
phone_config_template: templates/phone.tpl          # Путь к основному шаблону конфигурации
features_file: templates/features.yaml              # [Опционально] Путь к описанию расширенных функций
accounts_file: accounts.yaml                          # [Опционально] Путь к файлу описанию аккаунтов (динамические поля в UI для SIP линий)
```

### Настройка SIP-аккаунтов (accounts.yaml)

Файл `accounts_file` (обычно `accounts.yaml`) позволяет определить, какие поля будут отображаться в веб-интерфейсе при редактировании линии телефона (SIP-аккаунта). Это делает интерфейс динамическим и адаптируемым под разных производителей.

Например, если вендор требует настройки **Proxy IP** и **Proxy Port**, вы можете прописать их в `accounts.yaml`, и они автоматически появятся в диалоге редактирования линии.

Пример `accounts.yaml`:
```yaml
- id: account
  name: SIP Account
  params:
    - id: user_name
      label: Username
      type: string
    - id: password
      label: Password
      type: password
    - id: proxy_ip
      label: Proxy IP
      type: string
```

### Расширенная настройка функций (features.yaml)

Файл `features_file` позволяет описывать сложные программируемые кнопки (BLF, Speed Dial и др.) с пользовательскими полями в интерфейсе и шаблонами их выгрузки в конфиг. Шаблоны обрабатываются движком **Pongo2** (синтаксис как в Jinja2), что позволяет использовать условия, фильтры и динамическое сопоставление тегов.

#### Структура файла
Файл представляет собой список функций. Каждая функция содержит:
*   **`id`**: Уникальный идентификатор типа функции.
*   **`name`**: Понятное имя, отображаемое в выпадающем списке в UI.
*   **`params`**: Список параметров для настройки этой функции.

#### Поля параметров
*   **`id`**: Идентификатор параметра.
*   **`label`**: Заголовок поля в форме редактирования телефона.
*   **`type`**: Тип поля ввода (`string`, `boolean`, `number`, `select`, `hidden`).
*   **`value`**: (Опционально) Фиксированное значение (полезно для типа `hidden`).
*   **`source`**: (Опционально) Для типа `select` указывает источник данных (например, `lines`).
*   **`config_template`**: Шаблон строки, которая будет сгенерирована в конфигурации.

#### Подстановки в `config_template`
Шаблоны рендерятся движком **Pongo2** и имеют доступ к следующему контексту:

**Контекст параметра:**
*   **`{{id}}`**: ID текущего параметра (из `features.yaml`).
*   **`{{value}}`**: Значение текущего параметра.
*   **`{{[произвольное_поле]}}`**: Любые дополнительные поля, определенные для параметра в `features.yaml` (например, `{{param}}`).

**Контекст кнопки/линии (из модели и БД):**
*   **`{{key_index}}`**: Порядковый номер кнопки/линии (1-N).
*   **`{{key_number}}`**: Физический номер кнопки на устройстве или модуле расширения.
*   **`{{expansion_module}}`**: Номер модуля расширения (0 для самого телефона).
*   **`{{key_type}}`**: Тип кнопки из модели (например, `line`, `soft_key`).
*   **`{{label}}`**: Название (label) кнопки из модели.
*   **`{{tag}}`**: Сопоставленный тег вендора для данного ID параметра из `settings` модели.
*   **`{{settings}}`**: Полная карта всех настроек (`settings`), определенных для этой кнопки в модели.

#### Пример (Mitel BLF с произвольным параметром)
В `features.yaml`:
```yaml
- id: blf
  params:
    - id: label
      param: const
      config_template: "{{tag}}/{{param}}:{{value}}"
```
Если в модели для `label` определен тег `softkey3 label`, результат: `softkey3 label/const: MyValue`

### Шаблоны (Templates)

Шаблоны используют синтаксис **Pongo2** (аналог Jinja2 для Go). Они позволяют динамически формировать конфигурационные файлы на основе данных о телефоне и домене.

#### Доступные переменные в шаблонах

В шаблонах доступны следующие объекты:

1.  **`account`** — Объект текущего телефона:
    *   `mac_address`: MAC-адрес телефона (автоматически очищается от двоеточий, например `001565ABCDEF`). Доступны фильтры `|upper` и `|lower` для изменения регистра.
    *   `phone_number`: Основной номер телефона.
    *   `lines`: Список линий телефона.
        *   `number`: Номер линии (1, 2, ...).
        *   `auth_name`: Имя для авторизации (из Additional Info).
        *   `password`: Пароль (из Additional Info).
        *   `display_name`: Отображаемое имя.
        *   `registrar1_ip`, `registrar1_port`: Адрес SIP сервера.
    *   `max_lines`: Максимальное количество линий для данной модели.
    *   `lines_range`: Массив номеров линий (для итерации).
    *   `used_line_numbers`: Карта использованных номеров линий.

2.  **`domain`** — Объект текущего домена:
    *   `name`: Имя домена.
    *   Любые переменные, заданные в `provisioning-system.yaml` в секции `variables` (например, `domain.sip_server_ip`, `domain.ntp_server`).

3.  **`phones`** — Список всех телефонов в текущем домене (полезно для генерации справочников).

4.  **`all_domains`** — Список всех доменов и их телефонов (для глобальных справочников).

#### Пример шаблона (Cisco)

```xml
<flat-profile>
    <!-- Настройки VLAN из переменных домена -->
    {%- if domain.vlan_voip %}
    <Enable_VLAN>Yes</Enable_VLAN>
    <VLAN_ID>{{ domain.vlan_voip }}</VLAN_ID>
    {%- endif %}

    <!-- Итерация по линиям телефона -->
    {%- for line in account.lines %}
    {%- if line.type == "line" %}
    <!-- Линия {{line.number}} -->
    <User_ID_{{line.number}}_>{{ line.auth_name|default:line.phone_number }}</User_ID_{{line.number}}_>
    <Password_{{line.number}}_>{{ line.password|default:domain.sip_password }}</Password_{{line.number}}_>
    <Proxy_{{line.number}}_>{{ line.registrar1_ip|default:domain.sip_server_ip }}</Proxy_{{line.number}}_>
    {%- endif %}
    {%- endfor %}

    <!-- Глобальные настройки -->
    <Primary_NTP_Server>{{domain.ntp_server|default:"pool.ntp.org"}}</Primary_NTP_Server>
</flat-profile>
```

### Генерация справочников (Directory)

Для автоматической генерации телефонных книг создайте папку `directory` внутри папки вендора (например, `conf/vendors/cisco/directory/`). Поместите туда шаблон (например, `directory.xml.tpl`).

Этот шаблон будет автоматически обрабатываться при любом изменении телефонов, и результат будет сохранен в корень конфигурации домена.

Пример шаблона справочника:
```xml
{% for domain in all_domains %}
        <!-- Domain: {{ domain.name }} -->
        {% for phone in domain.phones %}
        <!-- Phone: {{ phone.MacAddress }} -->
<Description>{{ phone.Description }}</Description>
<Number>{{ phone.PhoneNumber }}</Number>
        {% for line in phone.Lines %}
        {% set info = line.GetAdditionalInfoMap() %}
<Entry>
<Name>{{ info.display_name }}</Name>
<UserName>{{ info.user_name }}</UserName>
<Registrar>{{ info.registrar1_ip }}</Registrar>
</Entry>
        {% endfor %}
        {% endfor %}
        {% endfor %}
```

## 5. Описание интерфейса

Веб-интерфейс системы предоставляет полный контроль над процессом провижининга.

### Вход в систему (Login)
При первом входе необходимо ввести логин и пароль администратора, заданные в `provisioning-system.yaml`.

### Дашборд (Dashboard)
Главная страница отображает общую статистику:
*   Общее количество телефонов в системе.
*   Распределение телефонов по доменам и вендорам.

### Телефоны (Phones)
Основной раздел для работы с устройствами.
*   **Поиск и фильтрация**: Поиск по MAC-адресу, номеру, описанию или IP-адресу. Фильтрация по домену и вендору.
*   **Добавление телефона**: Кнопка "Add Phone" открывает форму создания нового устройства.
*   **Редактирование**: Клик по строке таблицы открывает детальные настройки телефона.
*   **Импорт**: Кнопка "Import" позволяет массово загрузить телефоны из Excel-файла.

#### Формат файла Excel

Система поддерживает файлы `.xlsx` и `.xls`. Импортёр автоматически определяет колонки по ключевым словам в первой строке (заголовках).

| Параметр | Ключевые слова (RU) | Ключевые слова (EN) | Обязательно | Описание |
| :--- | :--- | :--- | :---: | :--- |
| **MAC адрес** | `мак`, `mac` | `mac` | Да | Уникальный MAC-адрес устройства |
| **Номер телефона**| `номер`, `number` | `number` | Да | Основной номер (Линия 1) |
| **Описание** | `описание`, `description` | Нет | Описание телефона |
| **Производитель** | `производитель`, `vendor`| `vendor` | Да | Название (Mitel) или ID (`mitel`) |
| **Модель** | `модель`, `model` | `model` | Да | Название модели (6873i) или её ID |
| **Домен** | `домен`, `domain` | `domain` | Нет | Имя домена (если пусто, будет выбран первый доступный) |
| **SIP Логин** | `логин`, `login` | `login` | Нет | Имя для авторизации (по умолчанию — номер) |
| **SIP Пароль** | `пароль`, `password`| `password` | Нет | Пароль (по умолчанию — из переменной домена `sip_password`) |

**Заметки:**
- Производители и модели должны быть заранее добавлены в систему.
- При импорте создается **одна SIP-линия** (Line 1).
- Если телефон с таким MAC уже существует, можно выбрать пропуск или перезапись.

#### Динамическое сопоставление колонок
Любая колонка в Excel-файле, которая не была распознана как стандартное поле (MAC, Номер, Производитель, Модель, Домен, Описание), будет автоматически импортирована в дополнительные параметры **Линии 1** (`additional_info`). Это позволяет массово загружать специфические для вендора настройки, такие как `proxy_ip`, `vlan_id` или `display_name`, прямо из вашей таблицы.

#### Редактирование телефона
В карточке телефона можно настроить:
*   **Основные параметры**: MAC, модель, домен, описание.
*   **Линии (Lines)**: Настройка SIP-аккаунтов для каждой линии (номер, пароль, display name).
*   **Кнопки (Keys)**: Настройка программируемых кнопок (BLF, Speed Dial), если модель это поддерживает.

### Система (System)
Раздел административных действий.
*   **Prepare Configuration (Reload)**: Перечитывает все файлы конфигурации (yaml, шаблоны) и генерирует конфигурационные файлы для всех телефонов. Используется после изменения шаблонов или глобальных настроек.
*   **Apply Configuration (Deploy)**: Применяет сгенерированные конфигурации (копирует их в рабочую папку TFTP/HTTP сервера).
*   **Backup/Restore**: Создание резервной копии базы данных и восстановление из неё.

### Отладка (Debug)
Лог обращений к встроенному серверу системы. Показывает обращения к файлам конфигурации и к несуществующим фалам (ошибки)
Имеется поиск по логу и фильтры. Лог ротируется.
Этот функционал не работает, в случае, если телефоны обращаются не к встроенному серверу, а к серверам, на которые выгружены конфигурации
